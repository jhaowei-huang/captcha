<!DOCTYPE html>
<html>
	<head>
		<link rel=stylesheet type="text/css" href="css/style.css">
		<script src = "javascript/jquery-2.1.1.min.js"></script>
		<script src = "javascript/jcanvas.min.js"></script>
		<script src = "javascript/Generator.js" async></script>
		<script src = "javascript/ImgProcessor.js" async></script>
		<script>

			$(document).ready(function() {
				var img = new Image();
				var intputImgURL;
				var w = document.getElementById("display").width,
					h = document.getElementById("display").height;
					
				img.src= "images/fish.jpg";
				img.onload = function() {
					var x_min = 40, x_max = 300 - x_min, 
						y_min = 40, y_max = 300 - y_min;

					$("#display").drawImage({
				  		source: img,
				  		x: w/2, y: h/2,
				  		width: w, height: h
					});

					var process = new ImgProcessor();
					process.edgeDetect(img);

					Generator.shrink(process.record);
					Generator.genCharsAndPos(function () {
						var counts = 0;

						while(counts < 5) {
							$("#display")
							.drawText({
								fillStyle: Generator.genColor(),
								x: Generator.captchaArray[counts].pos.x, 
								y: Generator.captchaArray[counts].pos.y,
								fontSize: Generator.captchaArray[counts].fsize,
								fontFamily: 'SWTOR Trajan, Italic',
								text: Generator.captchaArray[counts].symbol
							});

							$("#display").drawLine({
								strokeStyle: "#FF0000",
								strokeWidth: 3,
								x1: Generator.captchaArray[counts].pos.x + Generator.captchaArray[counts].fsize / 3, 
								y1: Generator.captchaArray[counts].pos.y + Generator.captchaArray[counts].fsize / 3,
								x2: Generator.captchaArray[counts].pos.x - Generator.captchaArray[counts].fsize / 3, 
								y2: Generator.captchaArray[counts].pos.y - Generator.captchaArray[counts].fsize / 3,
							});
							counts += 1;
						}
					});
					
					var str = "";
					for(var i = 0 ; i < 5 ; i++) {
						str += Generator.captchaArray[i].symbol;
					}
					
					$("#hint").html("HINT : " + str);
				}
				var canvas = document.getElementById("display");
				canvas.addEventListener("click", displayOnClick, false);
				$("#btn1").click(function(){
					
				});
			});
			
			function displayOnClick(e) {
				var canvas = document.getElementById("display");
				var x = e.x - canvas.offsetLeft;
    			var y = e.y - canvas.offsetTop;
    			if(Verifier.isMatch(x, y)) {
    				$("#ans").html(Verifier.ans);
    			}
    			else
    				$("#ans").html(Verifier.ans);
			}
		</script>
	</head>
	
	<body>		
		<p id = "p1"> img-based-CAPTCHA </p>
		<p id = "p2" style = "display:block"> Info. </p>
		<button id = "btn1"> Refresh </button>
		<HR>
		<canvas id = "display" width="300" height="300"></canvas> 
		<h id = "hint"> HINT : </h> <BR>
		<h id = "ans"> your answer : </h>
	</body>
</html>

