!function(e){function a(e){return e=e.replace(/\s/gi,"")}function t(){y.layer+=1}function r(){y.canvas+=1}function s(){y.global+=1}function n(a){var n={};n[a]=t,n[a]=r,u.setEventHooks(n),e.jCanvas.eventHooks[a]=s}function o(e){strictEqual(y.layer,e,"Triggers layer event callbacks"),strictEqual(y.canvas,e,"Triggers canvas event hooks"),strictEqual(y.global,e,"Triggers global event hooks")}function l(){u=e("<canvas width='500', height='500'></canvas>")}function i(){y={layer:0,canvas:0,global:0},e.jCanvas.clearCache(),e.jCanvas.eventHooks={}}var c=e("#qunit-fixture"),u,y;i(),module("Core API",{setup:l,teardown:i}),test("$.support.canvas",function(){strictEqual(e.support.canvas,!0,"Detects canvas support")}),test("saveCanvas()",function(){var a;u.saveCanvas(),a=e.data(u[0],"jCanvas"),strictEqual(a.savedTransforms.length,1,"Pushes transformation state to stack")}),test("restoreCanvas()",function(){var a;u.saveCanvas(),a=e.data(u[0],"jCanvas"),u.restoreCanvas(),strictEqual(a.savedTransforms.length,0,"Pops transformation state from stack")}),test("rotateCanvas()",function(){var a;u.rotateCanvas({rotate:180}),a=e.data(u[0],"jCanvas"),strictEqual(a.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(a.transforms.rotate,Math.PI,"Updates rotate property")}),test("scaleCanvas()",function(){var a;u.scaleCanvas({scale:2}),a=e.data(u[0],"jCanvas"),strictEqual(a.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(a.transforms.scaleX,2,"Updates scaleX property"),strictEqual(a.transforms.scaleY,2,"Updates scaleY property")}),test("translateCanvas()",function(){var a;u.translateCanvas({translate:2}),a=e.data(u[0],"jCanvas"),strictEqual(a.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(a.transforms.translateX,2,"Updates translateX property"),strictEqual(a.transforms.translateY,2,"Updates translateY property")}),module("Layer API",{setup:l,teardown:i}),test("getLayers()",function(){var a;deepEqual(e().getLayers(),[],"Returns array for empty collection"),deepEqual(c.getLayers(),[],"Returns array for non-canvas"),a=u.getLayers(),deepEqual(a,[],"Returns empty array for initial canvas"),strictEqual(u.getLayers(),a,"Returns a reference to the layers array")}),test("getLayer()",function(){var a,t;t={layer:!0},strictEqual(e().getLayer("square"),void 0,"Returns undefined for empty collection"),strictEqual(c.getLayer("square"),void 0,"Returns undefined for non-canvas"),strictEqual(u.getLayer("square"),void 0,"Returns undefined for non-existent layer"),strictEqual(u.getLayer(t),t,"Returns the given object"),u.addLayer({type:"rectangle",name:"square"}),u.addLayer({type:"arc",name:"circle"}),a=u.getLayer(0),strictEqual(e.type(a),"object","Layer can be retrieved by positive index"),strictEqual(u.getLayer(-2),a,"Layer can be retrieved by negative index"),strictEqual(u.getLayer("square"),a,"Layer can be retrieved by name"),strictEqual(u.getLayer(/^square$/gi),a,"Layer can be retrieved by regex"),strictEqual(u.getLayer(a),a,"Layer can be retrieved by object")}),test("getLayerGroup()",function(){var a;strictEqual(e().getLayerGroup("squares"),void 0,"Returns undefined for empty collection"),strictEqual(c.getLayerGroup("squares"),void 0,"Returns undefined for non-canvas"),strictEqual(u.getLayerGroup("squares"),void 0,"Returns undefined for non-existent group"),u.addLayer({type:"rectangle",name:"square",groups:["squares"]}),u.addLayer({type:"arc",name:"circle",groups:["ovals"]}),a=u.getLayerGroup("squares"),strictEqual(e.type(a),"array","Group can be retrieved by index"),strictEqual(u.getLayerGroup(/^squares$/gi),a,"Group can be retrieved by regex"),strictEqual(u.getLayerGroup(a),a,"Group can be retrieved by object"),strictEqual(a.length,1,"Group contains the proper number of layers"),strictEqual(a[0],u.getLayer("square"),"Group contains the proper layer")}),test("getLayerIndex()",function(){strictEqual(e().getLayerIndex("foo"),-1,"Returns -1 for empty collection"),strictEqual(c.getLayerIndex("foo"),-1,"Returns -1 for non-canvases"),strictEqual(u.getLayerIndex("foo"),-1,"Returns -1 for non-existent layer"),u.addLayer({type:"rectangle",name:"square"}),u.addLayer({type:"arc",name:"circle"}),strictEqual(u.getLayerIndex("square"),0,"Returns index of first layer"),strictEqual(u.getLayerIndex("circle"),1,"Returns index of second layer")}),test("setLayer()",function(){var e,a,r;n("change"),u.addLayer({type:"rectangle",name:"square",fillStyle:"black",width:100,height:100,change:t}),u.addLayer({type:"arc",name:"circle",change:t}),e=u.getLayer("square"),a=["boxes"],r={},u.setLayer(e,{fillStyle:"green",opacity:.5,name:"box",groups:a,data:r,width:"+=10",height:"-=10"}),strictEqual(e.fillStyle,"green","Sets fillStyle of layer"),strictEqual(e.opacity,.5,"Sets opacity of layer"),strictEqual(u.getLayer("box"),e,"Sets name of layer"),notStrictEqual(e.groups,a,"Clones arrays in property map"),notStrictEqual(e.data,r,"Clones objects in property map"),strictEqual(e.width,110,"Increments width by 10"),strictEqual(e.height,90,"Decrements width by 10"),o(1)}),test("setLayers()",function(){var e,a;n("change"),u.addLayer({type:"rectangle",name:"square",fillStyle:"black",change:t}),u.addLayer({type:"arc",name:"circle",fillStyle:"red",change:t}),e=u.getLayer("square"),a=u.getLayer("circle"),u.setLayers({fillStyle:"green"}),strictEqual(e.fillStyle,"green","Sets fillStyle of first layer"),strictEqual(a.fillStyle,"green","Sets fillStyle of second layer"),o(2)}),test("setLayerGroup()",function(){var e,a,r;n("change"),u.addLayer({type:"rectangle",name:"square",change:t}),u.addLayer({type:"arc",name:"circle",groups:["ovals"],change:t}),u.addLayer({type:"ellipse",name:"oval",groups:["ovals"],change:t}),e=u.getLayer("square"),a=u.getLayer("circle"),r=u.getLayer("oval"),u.setLayerGroup("ovals",{fillStyle:"green"}),strictEqual(a.fillStyle,"green","Sets properties of first layer in group"),strictEqual(r.fillStyle,"green","Sets properties of second layer in group"),notStrictEqual(e.fillStyle,"green","Does not set properties of layer outside of group"),o(2)}),test("moveLayer()",function(){n("move"),u.addLayer({type:"rectangle",name:"square",move:t}),u.addLayer({type:"arc",name:"circle"}),u.addLayer({type:"ellipse",name:"oval"}),u.moveLayer("square",1),strictEqual(u.getLayerIndex("square"),1,"Layer can be moved to positive index"),u.moveLayer("square",-1),strictEqual(u.getLayerIndex("square"),1,"Layer can be moved to negative index"),o(2)}),test("removeLayer()",function(){n("remove"),u.addLayer({type:"rectangle",name:"square",remove:t}),u.addLayer({type:"arc",name:"circle"}),u.removeLayer("square"),strictEqual(u.getLayers().length,1,void 0,"Removes layer from layers array"),strictEqual(u.getLayer("square"),void 0,"Layer is no longer retrievable"),o(1)}),test("removeLayers()",function(){n("remove"),u.addLayer({type:"rectangle",name:"square",remove:t}),u.addLayer({type:"arc",name:"circle",remove:t}),u.removeLayers(),strictEqual(u.getLayers().length,0,"Removes all layers from layers array"),strictEqual(u.getLayer("square"),void 0,"First layer is no longer retrievable"),strictEqual(u.getLayer("circle"),void 0,"Second layer is no longer retrievable"),o(2)}),test("removeLayerGroup()",function(){n("remove"),u.addLayer({type:"rectangle",name:"square"}),u.addLayer({type:"arc",name:"circle",groups:["ovals"],remove:t}),u.addLayer({type:"ellipse",name:"oval",groups:["ovals"],remove:t}),u.removeLayerGroup("ovals"),strictEqual(u.getLayers().length,1,"Removes layer group from layers array"),strictEqual(u.getLayerGroup("ovals"),void 0,"Layer group is no longer retrievable"),o(2)}),test("addLayerToGroup()",function(){var e,a,t;u.addLayer({type:"rectangle",name:"square",groups:["quadrilaterals"]}),u.addLayer({type:"arc",name:"circle"}),u.addLayer({type:"ellipse",name:"oval",groups:[]}),u.addLayerToGroup("square","squares"),u.addLayerToGroup("circle","ovals"),u.addLayerToGroup("oval","ovals"),a=u.getLayerGroup("squares"),t=u.getLayerGroup("ovals"),strictEqual(a.length,1,"Adds layer to group if layer is associated with at least one group"),strictEqual(t.length,2,"Adds layer to group if layer is not associated with any groups"),u.removeLayers(),e=["ovals"],u.addLayer({type:"arc",name:"circle",groups:e}),u.addLayer({type:"ellipse",name:"oval",groups:e}),u.addLayerToGroup("oval","ellipses"),strictEqual(u.getLayerGroup("ellipses").length,1,"Groups array is cloned upon layer creation")}),test("removeLayerFromGroup()",function(){var e,a;u.addLayer({type:"rectangle",name:"square",groups:["shapes","squares"]}),u.removeLayerFromGroup("square","squares"),e=u.getLayerGroup("shapes"),a=u.getLayerGroup("squares"),strictEqual(a,void 0,"Removes layer from group"),strictEqual(e.length,1,"Layer remains in other groups")}),module("Event API",{setup:l,teardown:i}),test("getEventHooks()",function(){deepEqual(e().getEventHooks(),{},"Returns object for empty collecion"),deepEqual(c.getEventHooks(),{},"Returns object for non-canvas"),deepEqual(u.getEventHooks(),{},"Returns object for canvas")}),test("setEventHooks()",function(){u.setEventHooks({add:e.noop}),strictEqual(u.getEventHooks().add,e.noop,"Sets event hooks for canvas")}),test("triggerLayerEvent()",function(){n("mousedown"),u.addLayer({type:"rectangle",name:"square",mousedown:t}),u.triggerLayerEvent("square","mousedown"),o(1)}),module("Animation API",{setup:l,teardown:i}),asyncTest("animateLayer()",function(){expect(9),u.addLayer({type:"path",opacity:1,fillStyle:"rgba(0, 0, 0)",strokeStyle:"#000",shadowColor:"rgba(0, 0, 0, 1)",strokeWidth:2,p1:{type:"line",x1:0,y1:0,x2:100,y2:100}}),u.animateLayer(0,{fillStyle:"#f00",strokeStyle:"rgb(255, 0, 0)",shadowColor:"rgba(255, 0, 0, 0.5)",strokeWidth:10,p1:{x1:50}},10,function(e){var t;strictEqual(a(e.fillStyle),"rgb(255,0,0)","Animates hexadecimal color"),strictEqual(a(e.strokeStyle),"rgb(255,0,0)","Animates RGB color"),strictEqual(a(e.shadowColor),"rgba(255,0,0,0.5)","Animates RGBA color"),strictEqual(e.strokeWidth,10,"Animates strokeWidth property"),strictEqual(e.p1.x1,50,"Sub-property is animated"),strictEqual(e["p1.x1"],void 0,"Sub-property alias is deleted"),t=!1,u.animateLayer(0,{opacity:.5},{duration:10,step:function(a,r){t||(ok(a>=e.opacity,"Layer opacity is animating from 1 to 0.5"),strictEqual(r.prop,"opacity","Hidden properties do not begin with underscore when step callback is running"),t=!0)},complete:function(e){strictEqual(e,u.getLayer(0),"Layer object is passed to complete callback"),start()}})})}),module("Text API",{setup:l,teardown:i}),test("drawText()",function(){var e;u.drawText({layer:!0,name:"text",fontFamily:"sans-serif",fontSize:36,text:"Hello"}),e=u.getLayer("text"),ok(e.width,"Width is calculated"),ok(e.height,"Height is calculated")}),test("measureText()",function(){var a,t;a={layer:!0,type:"text",fontFamily:"sans-serif",fontSize:36,text:"Hello"},t=u.measureText({fontFamily:"sans-serif",fontSize:36,text:"Hello"}),strictEqual(e.type(t.width),"number","Width is calculated for the given object"),strictEqual(e.type(t.height),"number","Height is calculated for the given object"),u.addLayer(a),t=u.measureText(0),strictEqual(e.type(t.width),"number","Width is calculated for the given layer"),strictEqual(e.type(t.height),"number","Height is calculated for the given layer")}),module("Image API",{setup:l,teardown:i}),asyncTest("drawImage()",function(){expect(4);var e=0;u.drawImage({layer:!0,name:"fish",source:"images/fish.jpg",load:function(a){e+=1,1===e?(strictEqual(u.getLayer("fish"),a,"Layer is passed to callback initially"),strictEqual(a.width,220,"Width is calculated"),strictEqual(a.height,138,"Height is calculated")):2===e&&(strictEqual(u.getLayer("fish"),a,"Layer is passed to callback on redraw"),start())}}),u.drawLayers()}),test("getCanvasImage()",function(){var e,a;e=c.getCanvasImage(),strictEqual(e,null,"Returns null for non-canvas elements"),e=u.getCanvasImage(),strictEqual(e.indexOf("data:image/png;base64,"),0,"Returns data URL of type image/png by default"),e=u.getCanvasImage("png"),strictEqual(e.indexOf("png"),11,"Returns data URL of type image/png"),e=u.getCanvasImage("jpeg"),strictEqual(e.indexOf("jpeg"),11,"Returns data URL of type image/jpeg"),a=u.getCanvasImage("jpeg",.5),notStrictEqual(e,a,"Returns data URL of type image/jpeg with 50% compression")})}(jQuery);